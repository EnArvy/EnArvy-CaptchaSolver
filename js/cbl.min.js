var CBL=function(d){var j={preprocess:function(){p("You should define a preprocess method!")},model_file:"",model_string:"",model_loaded:function(){},blob_min_pixels:1,blob_max_pixels:99999,pattern_width:20,pattern_height:20,blob_debug:"",allow_console_log:false,allow_console_warn:true,character_set:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"};d=d||{};for(var b in j){if(j.hasOwnProperty(b)&&!d.hasOwnProperty(b)){d[b]=j[b]}}var l={solve:function(t){return l.train(t)},train:function(u,y,z,w){var t="";var v;if(document.getElementById(u)!=null){v=document.getElementById(u)}else{v=document.createElement("img");v.src=u}var x=function(){if(!r){r=true;c=document.createElement("canvas");c.width=v.width;c.height=v.height;c.getContext("2d").drawImage(v,0,0);d.preprocess();var D=l.segmentBlobs(d.blob_min_pixels,d.blob_max_pixels,d.pattern_width,d.pattern_height,d.blob_debug);if(typeof y!=="undefined"&&typeof z!=="undefined"&&D.length){for(var A=0;A<D.length;A++){var C=D[A].toDataURL();var B=k(D[A]);o.push({imgSrc:C,pattern:B,imgId:y,txtId:z,self:l,onComplete:w})}if(!s){l.loadNextPattern()}s=true}else{for(var A=0;A<D.length;A++){t+=g(k(D[A]))}h("Solution = "+t)}l.reset()}};if(v.complete){x()}else{v.onload=x()}return t},loadNextPattern:function(){var t=o.pop();if(t){h("Loading a pattern for human classification.");document.getElementById(t.imgId).src=t.imgSrc;document.getElementById(t.txtId).focus();document.getElementById(t.txtId).onkeyup=function(u){var v=document.getElementById(t.txtId).value;if(d.character_set.indexOf(v)>-1&&v.length){e.push({pattern:t.pattern,solution:document.getElementById(t.txtId).value});h('Added "'+document.getElementById(t.txtId).value+'" pattern to model!');document.getElementById(t.txtId).value="";if(o.length){t.self.loadNextPattern()}else{s=false;document.getElementById(t.txtId).onkeyup=function(){};if(typeof t.onComplete==="function"){t.onComplete()}}}else{document.getElementById(t.txtId).value=""}}}},loadModelString:function(w){w=m.decompressFromBase64(w);e=new Array();var v=w.replace(/\[/g,"").split("]");for(var t=0;t<v.length;t++){var y=v[t].split("=");if(y.length==2){var x=y[1];var u=y[0];e.push({pattern:x,solution:u})}}if(!e.length){p("No patterns to load in provided model.")}else{h("Model loaded with "+e.length+" patterns!");d.model_loaded()}},loadModel:function(t){try{var v=new XMLHttpRequest();v.open("GET",t,true);v.send();v.onreadystatechange=function(){if(v.readyState==4&&v.status==200&&v.responseText){l.loadModelString(v.responseText)}}}catch(u){p('Could not load model from "'+t+'"! ('+u.message+")")}},saveModel:function(){var u="";for(var t=0;t<e.length;t++){u+="["+e[t].solution+"="+e[t].pattern+"]"}u=m.compressToBase64(u);return u},debugModel:function(){for(var t=0;t<e.length;t++){h(e[t].solution+" pattern length = "+e[t].pattern.split(".").length)}},condenseModel:function(){var z=new Array();var v=e.length;for(var y=0;y<e.length;y++){var u=e[y].pattern.split(".");var A=false;for(var w=0;w<z.length;w++){if(z[w].solution==e[y].solution){for(var t=0;t<z[w].tempArray.length;t++){z[w].tempArray[t]=parseInt(z[w].tempArray[t])+parseInt(u[t])}z[w].tempCount++;A=true;break}}if(!A){z.push({pattern:e[y].pattern,solution:e[y].solution,tempArray:u,tempCount:1})}}for(var y=0;y<z.length;y++){for(var t=0;t<z[y].tempArray.length;t++){z[y].tempArray[t]=Math.round(z[y].tempArray[t]/z[y].tempCount)}z[y].pattern=z[y].tempArray.join(".")}e=z;h("Condensed model from "+v+" patterns to "+e.length+" patterns!");return this},reset:function(t,u){r=false;c=null;return this},display:function(t){document.getElementById(t).src=c.toDataURL();return this},debugImage:function(t){var u=document.createElement("img");u.src=c.toDataURL();document.getElementById(t).appendChild(u);return this},segmentBlobs:function(N,K,M,w,J){if(typeof N==="undefined"){N=1}if(typeof K==="undefined"){K=100000}if(typeof M==="undefined"){M=20}if(typeof w==="undefined"){w=20}var H=c.getContext("2d").getImageData(0,0,c.width,c.height);var v=function(y,x){return y[x]*255*255+y[x+1]*256+y[x+2]};var C=new Array();for(var D=0;D<H.width;D++){for(var B=0;B<H.height;B++){var O=D*4+B*4*H.width;var t=v(H.data,O);if(!q(C,t)){C.push(t)}}}var Q=new Array();for(var R=0;R<C.length;R++){var u=document.createElement("canvas");u.width=H.width;u.height=H.height;var I=u.getContext("2d").getImageData(0,0,c.width,c.height);var z=I.data;var G=0;var A=H.width;var L=0;var E=H.height;var F=0;for(var D=0;D<H.width;D++){for(var B=0;B<H.height;B++){var O=D*4+B*4*H.width;var t=v(H.data,O);if(t==C[R]){z[O]=0;z[O+1]=0;z[O+2]=0;z[O+3]=255;G++;if(D<A){A=D}if(D>L){L=D}if(B<E){E=B}if(B>F){F=B}}else{z[O]=255;z[O+1]=255;z[O+2]=255;z[O+3]=255}}}if(G>=N&&G<=K){u.width=M;u.height=w;u.getContext("2d").putImageData(I,-A,-E,A,E,M,w);u.getContext("2d").drawImage(u,0,0,M*M/(L-A+1),w*w/(F-E+1));Q.push(u);if(typeof J!=="undefined"&&J.length){h("Blob size = "+G);var P=document.createElement("img");P.src=u.toDataURL();document.getElementById(J).appendChild(P)}}}return Q},colorRegions:function(v){var u=new Array();var z=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var t=0;t<z.width;t++){for(var A=0;A<z.height;A++){var w=t*4+A*4*z.width;if(!q(u,w)){l.floodfill(t,A,n(),v,z,u)}}}c.getContext("2d").putImageData(z,0,0);return this},color:function(v,u,t){return{r:v,g:u,b:t,a:255}},floodfill:function(B,A,O,J,F,L){var G=false;if(typeof F==="undefined"){G=true;F=c.getContext("2d").getImageData(0,0,c.width,c.height)}var N=F.data;var u=N.length;var v=[];var I=(B+A*F.width)*4;var K=I,D=I,M,E,C=F.width*4;var t=[N[I],N[I+1],N[I+2],N[I+3]];var z=N[I]+N[I+1]+N[I+2]+N[I+3];if(!a(I,t,z,O,N,u,J)){return false}v.push(I);while(v.length){I=v.pop();if(typeof L!=="undefined"){if(q(L,I)){continue}}if(i(I,t,z,O,N,u,J,L)){K=I;D=I;E=(I/C)*C;M=E+C;while(E<(D-=4)&&i(D,t,z,O,N,u,J,L)){}while(M>(K+=4)&&i(K,t,z,O,N,u,J,L)){}for(var H=D;H<K;H+=4){if(H-C>=0&&a(H-C,t,z,O,N,u,J)){v.push(H-C)}if(H+C<u&&a(H+C,t,z,O,N,u,J)){v.push(H+C)}}}}if(G){c.getContext("2d").putImageData(F,0,0)}},grayscale:function(){var w=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var t=0;t<w.width;t++){for(var z=0;z<w.height;z++){var u=t*4+z*4*w.width;var v=0.34*w.data[u]+0.5*w.data[u+1]+0.16*w.data[u+2];w.data[u]=v;w.data[u+1]=v;w.data[u+2]=v;w.data[u+3]=255}}c.getContext("2d").putImageData(w,0,0);return this},binarize:function(u){var z=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var t=0;t<z.width;t++){for(var A=0;A<z.height;A++){var v=t*4+A*4*z.width;var w=0.34*z.data[v]+0.5*z.data[v+1]+0.16*z.data[v+2];z.data[v]=w>=u?255:0;z.data[v+1]=w>=u?255:0;z.data[v+2]=w>=u?255:0;z.data[v+3]=255}}c.getContext("2d").putImageData(z,0,0);return this}};var e=new Array();var o=new Array();var s=false;var r=false;var c;var g=function(v){var w=4000000000;var t="?";for(var u=0;u<e.length;u++){h(e[u].pattern.length+" - "+v.length);var x=f(e[u].pattern,v);if(x<w){w=x;t=e[u].solution}}return t};var k=function(u){var w=new Array();var A=u.getContext("2d").getImageData(0,0,u.width,u.height);for(var t=0;t<A.width;t++){for(var B=0;B<A.height;B++){var v=t*4+B*4*A.width;var z=Math.round(0.34*A.data[v]+0.5*A.data[v+1]+0.16*A.data[v+2]);w.push(z)}}return w.join(".")};var f=function(y,x){var v=y.split(".");var u=x.split(".");var w=0;for(var t=0;t<v.length;t++){w+=(v[t]-u[t])*(v[t]-u[t])}return Math.sqrt(w/v.length)};var a=function(v,x,z,u,y,w,t){if(v<0||v>=w){return false}if(x[0]===u.r&&x[1]===u.g&&x[2]===u.b){return false}if(x[0]===y[v]&&x[1]===y[v+1]&&x[2]===y[v+2]){return true}if(Math.abs(x[0]-y[v])<=t&&Math.abs(x[1]-y[v+1])<=t&&Math.abs(x[2]-y[v+2])<=t){return true}return false};var i=function(w,y,A,v,z,x,u,t){if(a(w,y,A,v,z,x,u)){if(typeof t!=="undefined"){if(q(t,w)){return false}}z[w]=v.r;z[w+1]=v.g;z[w+2]=v.b;z[w+3]=v.a;if(typeof t!=="undefined"){t.push(w)}return true}return false};var q=function(t,v){for(var u=0;u<t.length;u++){if(t[u]===v){return true}}return false};var n=function(){var v=Math.round(Math.random()*200)+55;var u;var t;while((u=Math.round(Math.random()*200)+55)==v){}while((t=Math.round(Math.random()*200)+55)==v||t==u){}return l.color(v,u,t)};var h=function(t){if(d.allow_console_log){console.log("CBL: "+t)}};var p=function(t){if(d.allow_console_warn){console.warn("CBL: "+t)}};if(d.model_file.length){l.loadModel(d.model_file)}else{if(d.model_string.length){l.loadModelString(d.model_string)}}var m=function(){function y(A,t){if(!v[A]){v[A]={};for(var B=0;B<A.length;B++){v[A][A.charAt(B)]=B}}return v[A][t]}var w=String.fromCharCode,z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",v={},u={compressToBase64:function(A){if(null==A){return""}var t=u._compress(A,6,function(B){return z.charAt(B)});switch(t.length%4){default:case 0:return t;case 1:return t+"===";case 2:return t+"==";case 3:return t+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:u._decompress(t.length,32,function(A){return y(z,t.charAt(A))})},compressToUTF16:function(t){return null==t?"":u._compress(t,15,function(A){return w(A+32)})+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:u._decompress(t.length,16384,function(A){return t.charCodeAt(A)-32})},compressToUint8Array:function(E){for(var C=u.compress(E),F=new Uint8Array(2*C.length),D=0,A=C.length;A>D;D++){var B=C.charCodeAt(D);F[2*D]=B>>>8,F[2*D+1]=B%256}return F},decompressFromUint8Array:function(D){if(null===D||void 0===D){return u.decompress(D)}for(var E=new Array(D.length/2),C=0,A=E.length;A>C;C++){E[C]=256*D[2*C]+D[2*C+1]}var B=[];return E.forEach(function(t){B.push(w(t))}),u.decompress(B.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":u._compress(t,6,function(A){return x.charAt(A)})},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),u._decompress(t.length,32,function(A){return y(x,t.charAt(A))}))},compress:function(t){return u._compress(t,16,function(A){return w(A)})},_compress:function(C,A,D){if(null==C){return""}var J,P,G,Q={},B={},O="",L="",M="",F=2,I=3,H=2,K=[],E=0,N=0;for(G=0;G<C.length;G+=1){if(O=C.charAt(G),Object.prototype.hasOwnProperty.call(Q,O)||(Q[O]=I++,B[O]=!0),L=M+O,Object.prototype.hasOwnProperty.call(Q,L)){M=L}else{if(Object.prototype.hasOwnProperty.call(B,M)){if(M.charCodeAt(0)<256){for(J=0;H>J;J++){E<<=1,N==A-1?(N=0,K.push(D(E)),E=0):N++}for(P=M.charCodeAt(0),J=0;8>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}else{for(P=1,J=0;H>J;J++){E=E<<1|P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P=0}for(P=M.charCodeAt(0),J=0;16>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}F--,0==F&&(F=Math.pow(2,H),H++),delete B[M]}else{for(P=Q[M],J=0;H>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}F--,0==F&&(F=Math.pow(2,H),H++),Q[L]=I++,M=String(O)}}if(""!==M){if(Object.prototype.hasOwnProperty.call(B,M)){if(M.charCodeAt(0)<256){for(J=0;H>J;J++){E<<=1,N==A-1?(N=0,K.push(D(E)),E=0):N++}for(P=M.charCodeAt(0),J=0;8>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}else{for(P=1,J=0;H>J;J++){E=E<<1|P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P=0}for(P=M.charCodeAt(0),J=0;16>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}F--,0==F&&(F=Math.pow(2,H),H++),delete B[M]}else{for(P=Q[M],J=0;H>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}}F--,0==F&&(F=Math.pow(2,H),H++)}for(P=2,J=0;H>J;J++){E=E<<1|1&P,N==A-1?(N=0,K.push(D(E)),E=0):N++,P>>=1}for(;;){if(E<<=1,N==A-1){K.push(D(E));break}N++}return K.join("")},decompress:function(t){return null==t?"":""==t?null:u._decompress(t.length,32768,function(A){return t.charCodeAt(A)})},_decompress:function(I,J,P){var E,M,F,H,D,R,S,L,O=[],N=4,Q=4,K=3,C="",B=[],G={val:P(0),position:J,index:1};for(M=0;3>M;M+=1){O[M]=M}for(H=0,R=Math.pow(2,2),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}switch(E=H){case 0:for(H=0,R=Math.pow(2,8),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}L=w(H);break;case 1:for(H=0,R=Math.pow(2,16),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}L=w(H);break;case 2:return""}for(O[3]=L,F=L,B.push(L);;){if(G.index>I){return""}for(H=0,R=Math.pow(2,K),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}switch(L=H){case 0:for(H=0,R=Math.pow(2,8),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}O[Q++]=w(H),L=Q-1,N--;break;case 1:for(H=0,R=Math.pow(2,16),S=1;S!=R;){D=G.val&G.position,G.position>>=1,0==G.position&&(G.position=J,G.val=P(G.index++)),H|=(D>0?1:0)*S,S<<=1}O[Q++]=w(H),L=Q-1,N--;break;case 2:return B.join("")}if(0==N&&(N=Math.pow(2,K),K++),O[L]){C=O[L]}else{if(L!==Q){return null}C=F+F.charAt(0)}B.push(C),O[Q++]=F+C.charAt(0),N--,F=C,0==N&&(N=Math.pow(2,K),K++)}}};return u}();"function"==typeof define&&define.amd?define(function(){return m}):"undefined"!=typeof module&&null!=module&&(module.exports=m);return l};